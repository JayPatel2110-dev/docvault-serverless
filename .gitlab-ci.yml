stages:
  - validate
  - plan
  - apply

validate:
  stage: validate
  image: hashicorp/terraform:latest
  entrypoint: [""]
  script:
    - cd terraform
    - terraform init
    - terraform validate

plan:
  stage: plan
  image: hashicorp/terraform:latest
  entrypoint: [""]
  script:
    - cd lambda
    - zip -r lambda_function.zip .
    - cd ../terraform
    - cd terraform
    - terraform init
    - terraform plan -out=tfplan

apply:
  stage: apply 
  image: hashicorp/terraform:latest
  entrypoint: [""]
  script:
    - cd lambda
    - zip -r lambda_function.zip .
    - cd ../terraform
    - terraform init
    - terraform apply -auto-approve tfplan
    - sed -i "s|%%API_URL%%|$API_URL|g" frontend/index.html
    - sed -i "s|%%API_URL%%|$API_URL|g" frontend/register.html
    - sed -i "s|%%API_URL%%|$API_URL|g" frontend/dashboard.html
    - aws s3 cp frontend/index.html s3://$TF_VAR_bucket_name/index.html --content-type "text/html"
    - aws s3 cp frontend/register.html s3://$TF_VAR_bucket_name/register.html --content-type "text/html"
    - aws s3 cp frontend/dashboard.html s3://$TF_VAR_bucket_name/dashboard.html --content-type "text/html"
    - aws s3 sync frontend/ s3://$TF_VAR_bucket_name/ --exclude "*.html"
  when: manual